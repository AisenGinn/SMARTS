# WAYMO-SMARTS Replay Simulation
The WAYMO-SMARTS Replay Simulation allows users to take the WAYMO motion dataset provided as sharded TFRecord format files containing protocol buffer data and then the parse it in SMARTS to 
generate histories of the dataset and replay it in a SMARTS simulation allowing you to hijack the WAYMO's ego vehicle using your own agent.
You can read more about there open-source dataset [here](https://waymo.com/open/data/motion/) and their [Github Repo](https://github.com/waymo-research/waymo-open-dataset) for more information.

## Setup
Follow the instructions for the  setup of SMARTS given at [open-source](https://github.com/huawei-noah/SMARTS/)
Then download the `training_20s` Motion dataset from [here](https://waymo.com/open/download/) and save it in the folder `scenarios/waymo/waymo_dataset`. 
Currently, we have support scenarios of the dataset `uncompressed_scenario_training_20s_training_20s.tfrecord-00001-of-01000` which is the first file in `uncompressed/scenario/training_20s` at their cloud storage.

```bash
# install [waymo] version of python package to install the waymo-dataset package
pip install -e .[waymo]

# then you can generate the map, generate the histories for the vehicles, store their observations and replay the simulation. See details below...
```

## Generating the history database and creating the map
Go to `scenarios/waymo/training_20s.yaml` and make sure the  `input_path` entry has the correct path to your downloaded dataset. You can also modify `scenario_index` or `scenario_id` based on which scenario you want to replay for the following scenario map. 
Then go to the source level of the SMARTS repo and run the following command,
```bash
scl scenario build --clean scenarios/waymo
```
This should build the map for the dataset, and generate the SQLite database of type `.shf` at `scenarios/waymo/`

## Dumping the observations of vehicles in .pkl files from the history database
At the source level of the SMARTS, run the following command,
```bash
python3.7 examples/observation_collection_for_imitation_learning.py scenarios/waymo
```
This will create .pkl files storing the observations of each vehicle in that particular scenario that can be used to hijack a particular vehicle by your own Agent.

## Writing your own Agent to hijack the Waymo Ego vehicle
You can write and add your own agent in `examples/history_vehicles_replacement_for_imitation_learning.py` which will hijack
the ego_vehicle let you control it. Example

```python
class ReplayCheckerAgent(Agent):
    """This is just a place holder such that the example code here has a real Agent to work with.
    This agent checks that the action space is working 'as expected'.
    In actual use, this would be replaced by an agent based on a trained Imitation Learning model."""

    def __init__(self, fixed_timestep_sec: float):
        self._fixed_timestep_sec = fixed_timestep_sec
        self._rounder = rounder_for_dt(fixed_timestep_sec)
        self._time_offset = 0

    def load_data_for_vehicle(
        self, vehicle_id: str, scenario: Scenario, time_offset: float
    ):
        self._vehicle_id = vehicle_id  # for debugging
        self._time_offset = time_offset
        datafile = f"data_{scenario.name}_{scenario.traffic_history.name}_Agent-history-vehicle-{vehicle_id}.pkl"
        # We read actions from a datafile previously-generated by the
        # observation_collection_for_imitation_learning.py script.
        # This allows us to test the action space to ensure that it
        # can recreate the original behaviour.
        with open(datafile, "rb") as pf:
            self._data = pickle.load(pf)

    def act(self, obs: Observation) -> Tuple[float, float]:
        assert self._data

        # First, check the observations representing the current state
        # to see if it matches what we expected from the recorded data.
        obs_time = self._rounder(obs.elapsed_sim_time + self._time_offset)
        exp = self._data.get(obs_time)
        if not exp:
            return (0.0, 0.0)
        
        # Note: The following assertions can be used to compare how your agent behaves compared to the recorded 
        # observations of ego
        cur_state = obs.ego_vehicle_state
        # assert math.isclose(
        #     cur_state.heading, exp["heading"], abs_tol=1e-2
        # ), f'vid={self._vehicle_id}: {cur_state.heading} != {exp["heading"]} @ {obs_time}'
        # assert math.isclose(
        #     cur_state.speed, exp["speed"], abs_tol=1
        # ), f'vid={self._vehicle_id}: {cur_state.speed} != {exp["speed"]} @ {obs_time}'
        # assert math.isclose(
        #     cur_state.position[0], exp["ego_pos"][0], abs_tol=2
        # ), f'vid={self._vehicle_id}: {cur_state.position[0]} != {exp["ego_pos"][0]} @ {obs_time}'
        # assert math.isclose(
        #     cur_state.position[1], exp["ego_pos"][1], abs_tol=2
        # ), f'vid={self._vehicle_id}: {cur_state.position[1]} != {exp["ego_pos"][1]} @ {obs_time}'

        # Then get and return the next set of control inputs
        atime = self._rounder(obs_time + self._fixed_timestep_sec)
        data = self._data.get(atime, {"acceleration": 0, "angular_velocity": 0})
        return (data["acceleration"], data["angular_velocity"])
```
 And then you can modify the line 124 in the script to insert your agent,
```python
        # XXX replace with AgentSpec appropriate for your model
        agent_spec = AgentSpec(
            interface=AgentInterface.from_type(AgentType.Imitation),
            agent_builder=ReplayCheckerAgent,
            agent_params=smarts.fixed_timestep_sec,
```

## Replaying the Waymo Simulatino
At the source level of the SMARTS, run the following command,
```bash
# Start the envision server in the background
scl envision start &

# Run the following command and open visit http://localhost:8081/ in your browser to view your experiment.
python3.7 examples/history_vehicles_replacement_for_imitation_learning.py --episodes==1 -d=waymo scenarios/waymo
```
Then you can see the replay simulation of one of the scenarios of Waymo dataset on the envision server by visiting http://localhost:8081/ in your browser.

## Checking out other scenarios and dataset files
You can use the script `scenarios/waymo/waymo.py` to plot their scenario map and animate trajectories of vehicles on matplotlib or create
partial SUMO maps(They will be broken so cannot be used directly to simulate the replay. You will need to manually edit those maps).

```bash
# To plot a scenario_index 7 of a dataset map and animate trajectories of vehicles,
python3.7 waymo.py --animate=7 waymo_dataset/uncompressed_scenario_training_20s_training_20s.tfrecord-00001-of-01000

# To generate the sumo map of  a scenario_index 7 of a dataset map 
python3.7 waymo.py --gen=7 waymo_dataset/uncompressed_scenario_training_20s_training_20s.tfrecord-00001-of-01000
```
